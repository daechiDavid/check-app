<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생 출석체크 및 과제제출 관리</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #007bff;
            color: white;
        }

        .tab:hover:not(.active) {
            background: #e9ecef;
        }

        .content {
            display: none;
        }

        .content.active {
            display: block;
        }

        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .student-btn {
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .student-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .student-btn:hover::before {
            left: 100%;
        }

        /* 출석 상태 */
        .student-btn.absent {
            background: #6c757d;
            color: white;
        }

        .student-btn.present {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        /* 과제제출 상태 */
        .student-btn.not-submitted {
            background: #6c757d;
            color: white;
        }

        .student-btn.submitted {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .student-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        .student-btn:active {
            transform: translateY(0);
        }

        .controls {
            text-align: center;
            margin-bottom: 20px;
        }

        .control-btn {
            background: linear-gradient(135deg, #6f42c1, #e83e8c);
            color: white;
            border: none;
            padding: 12px 25px;
            margin: 0 10px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }        .summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.1em;
            color: #495057;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .student-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .student-status {
            font-size: 0.9em;
        }

        .upload-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .upload-section h3 {
            color: #495057;
            margin-bottom: 15px;
            text-align: center;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 25px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        .format-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2196f3;
        }

        .format-info h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .format-info code {
            background: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            color: #d63384;
        }

        .current-list {
            background: #fff;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .current-list h4 {
            color: #495057;
            margin-bottom: 10px;
            text-align: center;
        }

        .student-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }        .student-number {
            font-weight: bold;
            color: #007bff;
            margin-right: 10px;
        }

        .add-student-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }

        .add-student-section h4 {
            color: #155724;
            margin-bottom: 15px;
            text-align: center;
        }

        .add-form {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .add-input {
            padding: 10px 15px;
            border: 2px solid #28a745;
            border-radius: 8px;
            font-size: 1em;
            outline: none;
            transition: all 0.3s ease;
        }

        .add-input:focus {
            border-color: #20c997;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .add-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s ease;
        }        .delete-btn:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        /* 사이드바 스타일 */
        .sidebar {
            position: fixed;
            left: -250px;
            top: 0;
            width: 250px;
            height: 100vh;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            z-index: 1000;
            transition: left 0.3s ease;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-header {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
        }        .sidebar-nav {
            padding: 20px 0;
            flex: 1;
            overflow-y: auto;
        }

        .sidebar-item {
            display: block;
            padding: 15px 25px;
            color: white;
            text-decoration: none;
            font-size: 1.1em;
            transition: all 0.3s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
        }

        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.2);
            padding-left: 35px;
        }

        .sidebar-item.active {
            background: rgba(255, 255, 255, 0.3);
            border-right: 4px solid white;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .add-task-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-task-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #20c997, #17a2b8);
        }        .sidebar {
            display: flex;
            flex-direction: column;
        }

        /* 모달 스타일 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            transform: scale(0.7);
            transition: transform 0.3s ease;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .modal-header h3 {
            color: #333;
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .modal-input {
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            outline: none;
            transition: all 0.3s ease;
        }

        .modal-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .modal-btn.secondary {
            background: #6c757d;
            color: white;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .task-delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7em;
            cursor: pointer;
            margin-left: 8px;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .sidebar-item:hover .task-delete-btn {
            opacity: 1;
        }        .task-delete-btn:hover {
            background: #c82333;
        }

        /* 구분선 스타일 */
        .sidebar-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.3);
            margin: 10px 20px;
        }

        /* 순서 변경 버튼 스타일 */
        .task-order-controls {
            display: flex;
            flex-direction: column;
            position: absolute;
            right: 35px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .sidebar-item:hover .task-order-controls {
            opacity: 1;
        }

        .order-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 2px 4px;
            margin: 1px 0;
            border-radius: 2px;
            font-size: 0.6em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .order-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .order-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }        /* 과제 항목의 상대 위치 설정 */
        .sidebar-item {
            position: relative;
        }

        /* 드래그 앤 드롭 관련 스타일 */
        .sidebar-item.draggable {
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .sidebar-item.draggable:active {
            cursor: grabbing;
        }

        .sidebar-item.dragging {
            opacity: 0.8;
            transform: scale(0.95);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            background: rgba(255, 255, 255, 0.3);
            z-index: 1001;
        }

        .sidebar-item.drag-over {
            border-top: 2px dashed rgba(255, 255, 255, 0.7);
            padding-top: 17px;
        }

        .sidebar-item.drag-over-bottom {
            border-bottom: 2px dashed rgba(255, 255, 255, 0.7);
            padding-bottom: 17px;
        }

        .sidebar-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }

        .sidebar-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .main-content {
            margin-left: 0;
            transition: margin-left 0.3s ease;
            padding-top: 80px;
        }

        .main-content.shifted {
            margin-left: 250px;
        }        @media (max-width: 768px) {
            .main-content.shifted {
                margin-left: 0;
            }
            
            .sidebar {
                width: 100%;
                left: -100%;
            }
            
            .sidebar.open {
                left: 0;
            }
            
            .students-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 10px;
            }
            
            .student-btn {
                padding: 12px 15px;
                font-size: 0.9em;
            }
            
            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <!-- 사이드바 토글 버튼 -->
    <button class="sidebar-toggle" onclick="toggleSidebar()">
        ☰
    </button>

    <!-- 사이드바 오버레이 -->
    <div class="sidebar-overlay" onclick="closeSidebar()"></div>    <!-- 사이드바 -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            📚 학생 관리 시스템
        </div>        <div class="sidebar-nav">            <button class="sidebar-item active" onclick="switchTab('management')">
                👥 명단 관리
            </button>
              <!-- 구분선 -->
            <div class="sidebar-divider"></div>
              <button class="sidebar-item draggable" 
                    onclick="switchTab('attendance')"
                    draggable="true"
                    data-task-id="attendance"
                    data-task-type="default"
                    ondragstart="handleUnifiedDragStart(event)"
                    ondragover="handleDragOver(event)"
                    ondrop="handleUnifiedDrop(event)"
                    ondragenter="handleDragEnter(event)"
                    ondragleave="handleDragLeave(event)"
                    ondragend="handleDragEnd(event)">
                ✏️ 꿈문 제출
                <span class="task-delete-btn" onclick="event.stopPropagation(); deleteDefaultTask('attendance')">🗑️</span>
            </button>
            <button class="sidebar-item draggable" 
                    onclick="switchTab('assignment')"
                    draggable="true"
                    data-task-id="assignment"
                    data-task-type="default"
                    ondragstart="handleUnifiedDragStart(event)"
                    ondragover="handleDragOver(event)"
                    ondrop="handleUnifiedDrop(event)"
                    ondragenter="handleDragEnter(event)"
                    ondragleave="handleDragLeave(event)"
                    ondragend="handleDragEnd(event)">
                📋 알림장 검사
                <span class="task-delete-btn" onclick="event.stopPropagation(); deleteDefaultTask('assignment')">🗑️</span>
            </button>
            <div id="dynamic-tasks">
                <!-- 동적으로 추가된 과제들이 여기에 표시됩니다 -->
            </div>
        </div>
        <div class="sidebar-footer">
            <button class="add-task-btn" onclick="showAddTaskModal()">
                ➕ 과제 추가
            </button>
        </div>
    </nav>

    <!-- 메인 컨텐츠 -->
    <div class="main-content" id="mainContent">        <div class="container">
            <h1 id="main-header">📚 학생 관리 시스템</h1>

            <div id="management" class="content active">
                <div class="upload-section">
                    <h3>📋 학생 명단 업로드</h3>
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div class="file-input-wrapper">
                            <input type="file" id="studentFile" class="file-input" accept=".txt,.csv" onchange="handleFileUpload(event)">
                            <label for="studentFile" class="file-input-label">
                                📁 명단 파일 선택
                            </label>
                        </div>
                    </div>

                    <div class="format-info">
                        <h4>📝 파일 형식 안내</h4>
                        <p><strong>지원 형식:</strong> .txt, .csv 파일</p>
                        <p><strong>형식 예시:</strong></p>
                        <div style="margin: 10px 0;">
                            <code>1 김민수</code><br>
                            <code>2 이지은</code><br>
                            <code>3 박준호</code><br>
                            <code>...</code>
                        </div>
                        <p><small>* 한 줄에 하나씩, "번호 이름" 형식으로 작성해주세요.</small></p>
                    </div>

                    <div style="text-align: center;">
                        <button class="control-btn" onclick="clearStudentList()">전체 명단 삭제</button>
                    </div>
                </div>

                <div class="add-student-section">
                    <h4>➕ 학생 개별 추가</h4>
                    <div class="add-form">
                        <input type="number" id="studentNumber" class="add-input" placeholder="번호" min="1" style="width: 80px;">
                        <input type="text" id="studentName" class="add-input" placeholder="학생 이름" style="width: 150px;">
                        <button class="add-btn" onclick="addSingleStudent()">추가</button>
                    </div>
                    <p style="text-align: center; margin-top: 10px; color: #6c757d; font-size: 0.9em;">
                        * 번호를 입력하지 않으면 자동으로 다음 번호가 부여됩니다.
                    </p>
                </div>

                <div class="current-list">
                    <h4>현재 등록된 학생 명단 (<span id="student-count">0</span>명)</h4>
                    <div id="student-list-display">
                        <!-- 현재 학생 목록이 여기에 표시됩니다 -->
                    </div>
                </div>
            </div>

            <div id="attendance" class="content">
                <div class="controls">
                    <button class="control-btn" onclick="resetAll('attendance')">전체 초기화</button>
                    <button class="control-btn" onclick="markAllPresent()">전체 제출</button>
                </div>
                <div class="students-grid" id="attendance-grid">
                    <!-- 출석 체크 버튼들이 여기에 생성됩니다 -->
                </div>
                <div class="summary" id="attendance-summary">
                    <!-- 출석 요약이 여기에 표시됩니다 -->
                </div>
            </div>

            <div id="assignment" class="content">
                <div class="controls">
                    <button class="control-btn" onclick="resetAll('assignment')">전체 초기화</button>
                    <button class="control-btn" onclick="markAllSubmitted()">전체 제출</button>
                </div>
                <div class="students-grid" id="assignment-grid">
                    <!-- 과제 제출 버튼들이 여기에 생성됩니다 -->
                </div>
                <div class="summary" id="assignment-summary">
                    <!-- 과제 요약이 여기에 표시됩니다 -->
                </div>
            </div>

            <!-- 동적 과제 컨텐츠가 여기에 추가됩니다 -->
            <div id="dynamic-task-contents">
                <!-- JavaScript로 동적 생성된 과제 페이지들 -->
            </div>
        </div>
    </div>

    <!-- 과제 추가 모달 -->
    <div class="modal" id="addTaskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📝 새 과제 추가</h3>
                <p>새로운 과제를 추가하여 학생들의 제출 상황을 관리하세요.</p>
            </div>
            <div class="modal-form">
                <input type="text" id="taskName" class="modal-input" placeholder="과제 이름 (예: 수학 숙제, 과학 보고서)">
                <input type="text" id="taskIcon" class="modal-input" placeholder="아이콘 (이모지 1개, 예: 📖, 🧮, 🔬)" maxlength="2">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeAddTaskModal()">취소</button>
                <button class="modal-btn primary" onclick="addNewTask()">추가</button>
            </div>
        </div>
    </div>    <script>
        // 학생 명단 (번호와 이름을 포함한 객체 배열)
        let students = [];

        // 상태 관리 객체 (학생ID 기반)
        let attendanceStatus = {};
        let assignmentStatus = {};
        let dynamicTaskStatuses = {}; // 동적 과제 상태들        // 동적 과제 목록
        let dynamicTasks = [];

        // 전체 과제 순서 관리 (기본 과제 + 동적 과제 ID를 모두 포함)
        let allTasksOrder = ['attendance', 'assignment']; // 기본 순서

        // localStorage 키
        const STORAGE_KEY = 'student_roster';

        // 학생 고유 ID 생성 (번호 기반)
        function getStudentId(number, name) {
            return `${number}_${name}`;
        }        // 앱 시작시 데이터 로드
        function loadFromStorage() {
            const storedData = localStorage.getItem(STORAGE_KEY);
            console.log('저장된 데이터 확인:', storedData);
            if (storedData) {
                try {
                    const parsedData = JSON.parse(storedData);
                    students = parsedData.students || [];
                    attendanceStatus = parsedData.attendanceStatus || {};
                    assignmentStatus = parsedData.assignmentStatus || {};
                    dynamicTaskStatuses = parsedData.dynamicTaskStatuses || {};
                    dynamicTasks = parsedData.dynamicTasks || [];
                    allTasksOrder = parsedData.allTasksOrder || ['attendance', 'assignment'];
                    console.log('데이터 로드 성공:', parsedData);
                } catch (error) {
                    console.error('저장된 데이터 로드 실패:', error);
                }
            } else {
                console.log('저장된 데이터가 없습니다.');
            }
        }
                 // localStorage에 데이터 저장
        function saveToStorage() {
            const dataToSave = {
                students: students,
                attendanceStatus: attendanceStatus,
                assignmentStatus: assignmentStatus,
                dynamicTaskStatuses: dynamicTaskStatuses,
                dynamicTasks: dynamicTasks,
                allTasksOrder: allTasksOrder
            };
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                console.log('데이터 저장 성공:', dataToSave);
            } catch (error) {
                console.error('localStorage 저장 실패:', error);
                alert('데이터 저장에 실패했습니다: ' + error.message);
            }
        }

        // 파일 업로드 처리
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                parseStudentList(content);
            };
            reader.readAsText(file, 'UTF-8');
        }        // 학생 명단 파싱
        function parseStudentList(content) {
            const lines = content.split('\n').filter(line => line.trim());
            const newStudents = [];

            for (let line of lines) {
                line = line.trim();
                if (!line) continue;

                // 번호와 이름을 분리 (공백, 탭, 쉼표로 분리)
                const parts = line.split(/[\s,]+/);
                if (parts.length >= 2) {
                    const number = parseInt(parts[0]);
                    const name = parts.slice(1).join(' '); // 나머지를 이름으로 결합
                    
                    if (!isNaN(number) && name) {
                        // 동일한 번호가 있는지 체크
                        const existingStudent = newStudents.find(s => s.number === number);
                        if (existingStudent) {
                            alert(`중복된 번호가 발견되었습니다: ${number}번 (${existingStudent.name}, ${name})\n파일을 다시 확인해주세요.`);
                            return;
                        }
                        newStudents.push({ number: number, name: name });
                    }
                }
            }

            if (newStudents.length === 0) {
                alert('올바른 형식의 학생 정보를 찾을 수 없습니다.\n\n형식: "번호 이름"');
                return;
            }

            // 번호 순으로 정렬
            newStudents.sort((a, b) => a.number - b.number);
            
            // 학생 배열 업데이트
            students = newStudents;

            // 상태 초기화
            initializeStatuses();
            
            // UI 업데이트
            updateUI();
            
            // 저장
            saveToStorage();

            alert(`${students.length}명의 학생이 성공적으로 등록되었습니다!`);
        }        // 상태 초기화
        function initializeStatuses() {
            attendanceStatus = {};
            assignmentStatus = {};
            
            students.forEach(student => {
                const studentId = getStudentId(student.number, student.name);
                attendanceStatus[studentId] = 'absent';
                assignmentStatus[studentId] = 'not-submitted';
                
                // 동적 과제들에 대해서도 초기화
                dynamicTasks.forEach(task => {
                    if (!dynamicTaskStatuses[task.id]) {
                        dynamicTaskStatuses[task.id] = {};
                    }
                    dynamicTaskStatuses[task.id][studentId] = 'not-submitted';
                });
            });
        }

        // 학생 명단 삭제
        function clearStudentList() {
            if (confirm('모든 학생 명단과 출석/과제 데이터가 삭제됩니다. 계속하시겠습니까?')) {
                students = [];
                attendanceStatus = {};
                assignmentStatus = {};
                updateUI();
                saveToStorage();
                alert('학생 명단이 삭제되었습니다.');
            }
        }        // UI 전체 업데이트
        function updateUI() {
            createStudentButtons();
            updateSummary('attendance');
            updateSummary('assignment');
            displayCurrentStudentList();
            updateDynamicTasks();
            updateDynamicTaskButtons();
        }// 현재 학생 목록 표시
        function displayCurrentStudentList() {
            const listDisplay = document.getElementById('student-list-display');
            const countDisplay = document.getElementById('student-count');
            
            countDisplay.textContent = students.length;
            
            if (students.length === 0) {
                listDisplay.innerHTML = '<p style="text-align: center; color: #6c757d;">등록된 학생이 없습니다.</p>';
                return;
            }

            listDisplay.innerHTML = students.map((student, index) => `
                <div class="student-item">
                    <span><span class="student-number">${student.number}</span>${student.name}</span>
                    <button class="delete-btn" onclick="deleteSingleStudent(${index})" title="삭제">
                        🗑️ 삭제
                    </button>
                </div>
            `).join('');
        }        // 학생 개별 추가
        function addSingleStudent() {
            const numberInput = document.getElementById('studentNumber');
            const nameInput = document.getElementById('studentName');
            
            const name = nameInput.value.trim();
            if (!name) {
                alert('학생 이름을 입력해주세요.');
                nameInput.focus();
                return;
            }

            let number = parseInt(numberInput.value);
            
            // 번호가 없으면 다음 사용 가능한 번호 찾기
            if (isNaN(number) || number < 1) {
                number = getNextAvailableNumber();
            }

            // 중복 번호 체크
            const existingStudent = students.find(s => s.number === number);
            if (existingStudent) {
                alert(`${number}번은 이미 ${existingStudent.name} 학생이 사용중입니다.\n다른 번호를 입력해주세요.`);
                numberInput.focus();
                return;
            }

            // 새 학생 객체 생성
            const newStudent = { number: number, name: name };
            
            // 번호 순서에 맞게 삽입
            const insertIndex = students.findIndex(s => s.number > number);
            if (insertIndex === -1) {
                students.push(newStudent);
            } else {
                students.splice(insertIndex, 0, newStudent);
            }

            // 상태 초기화 (새 학생)
            const studentId = getStudentId(number, name);
            attendanceStatus[studentId] = 'absent';
            assignmentStatus[studentId] = 'not-submitted';
            
            // 동적 과제들에 대해서도 초기화
            dynamicTasks.forEach(task => {
                if (!dynamicTaskStatuses[task.id]) {
                    dynamicTaskStatuses[task.id] = {};
                }
                dynamicTaskStatuses[task.id][studentId] = 'not-submitted';
            });

            // UI 업데이트
            updateUI();
            saveToStorage();

            // 입력 필드 초기화
            numberInput.value = '';
            nameInput.value = '';
            nameInput.focus();

            alert(`${name} 학생이 ${number}번으로 추가되었습니다.`);
        }

        // 다음 사용 가능한 번호 찾기
        function getNextAvailableNumber() {
            if (students.length === 0) return 1;
            
            // 1번부터 시작해서 비어있는 번호 찾기
            for (let i = 1; i <= students.length + 1; i++) {
                if (!students.find(s => s.number === i)) {
                    return i;
                }
            }
            return students.length + 1;
        }        // 학생 개별 삭제
        function deleteSingleStudent(index) {
            const student = students[index];
            const studentId = getStudentId(student.number, student.name);
            
            if (confirm(`${student.number}번 ${student.name} 학생을 삭제하시겠습니까?\n(출석 및 과제 데이터도 함께 삭제됩니다)`)) {
                // 학생 삭제
                students.splice(index, 1);
                
                // 상태 데이터 삭제
                delete attendanceStatus[studentId];
                delete assignmentStatus[studentId];
                
                // 동적 과제들에서도 삭제
                dynamicTasks.forEach(task => {
                    if (dynamicTaskStatuses[task.id]) {
                        delete dynamicTaskStatuses[task.id][studentId];
                    }
                });

                // UI 업데이트
                updateUI();
                saveToStorage();

                alert(`${student.number}번 ${student.name} 학생이 삭제되었습니다.`);
            }
        }

        // Enter 키 이벤트 처리
        document.addEventListener('DOMContentLoaded', function() {
            const nameInput = document.getElementById('studentName');
            const numberInput = document.getElementById('studentNumber');
            
            if (nameInput) {
                nameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addSingleStudent();
                    }
                });
            }
            
            if (numberInput) {
                numberInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        nameInput.focus();
                    }
                });
            }
        });        // 초기화
        function initializeApp() {
            loadFromStorage();
            
            // 기존 동적 과제들의 컨텐츠 생성
            dynamicTasks.forEach(task => {
                createDynamicTaskContent(task);
            });
            
            updateUI();
            updateAllTasksOrder();
            
            // 초기 헤더 설정 (명단 관리가 기본 활성 탭)
            updateHeaderTitle('management');
        }// 학생 버튼 생성
        function createStudentButtons() {
            const attendanceGrid = document.getElementById('attendance-grid');
            const assignmentGrid = document.getElementById('assignment-grid');
            
            attendanceGrid.innerHTML = '';
            assignmentGrid.innerHTML = '';

            students.forEach(student => {
                const studentId = getStudentId(student.number, student.name);
                
                // 출석 버튼 생성
                const attendanceBtn = document.createElement('button');
                attendanceBtn.className = `student-btn ${attendanceStatus[studentId]}`;
                attendanceBtn.innerHTML = `
                    <div class="student-name">${student.number}번 ${student.name}</div>
                    <div class="student-status">${getStatusText(attendanceStatus[studentId], 'attendance')}</div>
                `;
                attendanceBtn.onclick = () => toggleStatus(studentId, 'attendance');
                attendanceGrid.appendChild(attendanceBtn);

                // 과제 버튼 생성
                const assignmentBtn = document.createElement('button');
                assignmentBtn.className = `student-btn ${assignmentStatus[studentId]}`;
                assignmentBtn.innerHTML = `
                    <div class="student-name">${student.number}번 ${student.name}</div>
                    <div class="student-status">${getStatusText(assignmentStatus[studentId], 'assignment')}</div>
                `;
                assignmentBtn.onclick = () => toggleStatus(studentId, 'assignment');
                assignmentGrid.appendChild(assignmentBtn);
            });
        }

        // 상태 텍스트 반환
        function getStatusText(status, type) {
            if (type === 'attendance') {
                return status === 'absent' ? '미제출' : '제출';
            } else {
                return status === 'not-submitted' ? '미제출' : '제출';
            }
        }        // 상태 토글
        function toggleStatus(studentId, type) {
            if (type === 'attendance') {
                attendanceStatus[studentId] = attendanceStatus[studentId] === 'absent' ? 'present' : 'absent';
            } else {
                assignmentStatus[studentId] = assignmentStatus[studentId] === 'not-submitted' ? 'submitted' : 'not-submitted';
            }
            
            createStudentButtons();
            updateSummary(type);
            saveToStorage(); // 상태 변경시 저장
        }        // 탭 전환
        function switchTab(tabName) {
            // 모든 탭과 컨텐츠 비활성화
            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            
            // 선택된 탭과 컨텐츠 활성화
            event.target.classList.add('active');
            const contentElement = document.getElementById(tabName);
            if (contentElement) {
                contentElement.classList.add('active');
            }
            
            // 헤더 제목 업데이트
            updateHeaderTitle(tabName);
            
            // 모바일에서는 탭 전환 시 사이드바 자동 닫기
            if (window.innerWidth <= 768) {
                closeSidebar();
            }
        }

        // 헤더 제목 업데이트 함수
        function updateHeaderTitle(tabName) {
            const headerElement = document.getElementById('main-header');
            if (!headerElement) return;
            
            const titleMap = {
                'management': '📚 학생 관리 시스템',
                'attendance': '✏️ 꿈문 제출',
                'assignment': '📋 알림장 검사'
            };
            
            // 동적 과제인 경우
            const dynamicTask = dynamicTasks.find(task => task.id === tabName);
            if (dynamicTask) {
                headerElement.textContent = `${dynamicTask.icon} ${dynamicTask.name}`;
            } else {
                headerElement.textContent = titleMap[tabName] || '📚 학생 관리 시스템';
            }
        }

        // 사이드바 토글
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const overlay = document.querySelector('.sidebar-overlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
            
            // 데스크톱에서만 메인 컨텐츠 이동
            if (window.innerWidth > 768) {
                mainContent.classList.toggle('shifted');
            }
        }

        // 사이드바 닫기
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const overlay = document.querySelector('.sidebar-overlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('active');            mainContent.classList.remove('shifted');
        }

        // 과제 추가 모달 관련 함수들
        function showAddTaskModal() {
            document.getElementById('addTaskModal').classList.add('active');
        }

        function closeAddTaskModal() {
            document.getElementById('addTaskModal').classList.remove('active');
            document.getElementById('taskName').value = '';
            document.getElementById('taskIcon').value = '';
        }        function addNewTask() {
            const taskName = document.getElementById('taskName').value.trim();
            const taskIcon = document.getElementById('taskIcon').value.trim();

            if (!taskName) {
                alert('과제 이름을 입력해주세요.');
                return;
            }

            const taskId = 'task_' + Date.now();
            const newTask = {
                id: taskId,
                name: taskName,
                icon: taskIcon || '📝'
            };

            dynamicTasks.push(newTask);
            
            // allTasksOrder에도 새 과제 추가
            allTasksOrder.push(taskId);
            
            // 새 과제에 대한 상태 초기화
            dynamicTaskStatuses[taskId] = {};
            students.forEach(student => {
                const studentId = getStudentId(student.number, student.name);
                dynamicTaskStatuses[taskId][studentId] = 'not-submitted';
            });

            // UI 업데이트
            updateDynamicTasks();
            updateAllTasksOrder();
            createDynamicTaskContent(newTask);
            saveToStorage();
            closeAddTaskModal();

            alert(`"${taskName}" 과제가 추가되었습니다!`);
        }        function deleteTask(taskId) {
            const task = dynamicTasks.find(t => t.id === taskId);
            if (!task) return;

            if (confirm(`"${task.name}" 과제를 삭제하시겠습니까?\n(모든 제출 데이터가 삭제됩니다)`)) {
                // 과제 삭제
                dynamicTasks = dynamicTasks.filter(t => t.id !== taskId);
                delete dynamicTaskStatuses[taskId];

                // allTasksOrder에서도 제거
                allTasksOrder = allTasksOrder.filter(id => id !== taskId);

                // UI에서 제거
                const contentElement = document.getElementById(taskId);
                if (contentElement) {
                    contentElement.remove();
                }

                updateDynamicTasks();
                updateAllTasksOrder();
                saveToStorage();

                // 삭제된 과제가 현재 활성화된 탭이라면 첫 번째 탭으로 이동
                if (document.getElementById(taskId) && document.getElementById(taskId).classList.contains('active')) {
                    const firstSidebarItem = document.querySelector('.sidebar-item');
                    if (firstSidebarItem) {
                        firstSidebarItem.click();
                        // 헤더도 업데이트
                        const firstTabName = firstSidebarItem.onclick.toString().match(/switchTab\('(.+?)'\)/)?.[1] || 'management';
                        updateHeaderTitle(firstTabName);
                    }
                }

                alert(`"${task.name}" 과제가 삭제되었습니다.`);
            }
        }// 기본 과제 삭제 함수
        function deleteDefaultTask(taskType) {
            const taskNames = {
                'attendance': '꿈문 제출',
                'assignment': '알림장 검사'
            };
            
            const taskName = taskNames[taskType];
            if (!taskName) return;
            
            if (confirm(`"${taskName}" 기본 과제를 삭제하시겠습니까?\n(모든 상태 데이터가 삭제되고 사이드바에서 제거됩니다)`)) {
                // 해당 과제의 상태 데이터 완전 삭제
                if (taskType === 'attendance') {
                    attendanceStatus = {};
                    // localStorage에서도 해당 데이터 완전 제거
                    const storedData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                    delete storedData.attendanceStatus;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(storedData));
                } else if (taskType === 'assignment') {
                    assignmentStatus = {};
                    // localStorage에서도 해당 데이터 완전 제거
                    const storedData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                    delete storedData.assignmentStatus;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(storedData));
                }
                
                // allTasksOrder에서도 제거
                allTasksOrder = allTasksOrder.filter(id => id !== taskType);
                
                // 사이드바에서 해당 항목 제거
                const sidebarItems = document.querySelectorAll('.sidebar-item');
                sidebarItems.forEach(item => {
                    if (item.onclick && item.onclick.toString().includes(`switchTab('${taskType}')`)) {
                        item.remove();
                    }
                });
                
                // 메인 컨텐츠에서 해당 섹션 제거
                const contentElement = document.getElementById(taskType);
                if (contentElement) {
                    contentElement.remove();
                }
                
                // 삭제된 과제가 현재 활성화된 탭이라면 첫 번째 탭으로 이동
                const activeContent = document.querySelector('.content.active');
                if (activeContent && activeContent.id === taskType) {
                    // 첫 번째 사이드바 항목으로 이동
                    const firstSidebarItem = document.querySelector('.sidebar-item');
                    if (firstSidebarItem) {
                        firstSidebarItem.click();
                        // 헤더도 업데이트
                        const firstTabName = firstSidebarItem.onclick.toString().match(/switchTab\('(.+?)'\)/)?.[1] || 'management';
                        updateHeaderTitle(firstTabName);
                    }
                }
                  // 전체 데이터 다시 저장하여 확실히 반영
                saveToStorage();
                
                alert(`"${taskName}" 기본 과제가 삭제되었습니다.`);
            }
        }function updateDynamicTasks() {
            const dynamicTasksContainer = document.getElementById('dynamic-tasks');
            
            dynamicTasksContainer.innerHTML = dynamicTasks.map((task, index) => `
                <button class="sidebar-item draggable" 
                        onclick="switchTab('${task.id}')"
                        draggable="true"
                        data-task-id="${task.id}"
                        data-task-index="${index}"
                        data-task-type="dynamic"
                        ondragstart="handleUnifiedDragStart(event)"
                        ondragover="handleDragOver(event)"
                        ondrop="handleUnifiedDrop(event)"
                        ondragenter="handleDragEnter(event)"
                        ondragleave="handleDragLeave(event)"
                        ondragend="handleDragEnd(event)">
                    ${task.icon} ${task.name}
                    <span class="task-delete-btn" onclick="event.stopPropagation(); deleteTask('${task.id}')">🗑️</span>
                </button>
            `).join('');
        }

        function createDynamicTaskContent(task) {
            const dynamicContentContainer = document.getElementById('dynamic-task-contents');
            
            const taskContent = document.createElement('div');
            taskContent.id = task.id;
            taskContent.className = 'content';
            taskContent.innerHTML = `
                <div class="controls">
                    <button class="control-btn" onclick="resetAllDynamic('${task.id}')">전체 초기화</button>
                    <button class="control-btn" onclick="markAllSubmittedDynamic('${task.id}')">전체 제출</button>
                </div>
                <div class="students-grid" id="${task.id}-grid">
                    <!-- 동적 과제 버튼들이 여기에 생성됩니다 -->
                </div>
                <div class="summary" id="${task.id}-summary">
                    <!-- 동적 과제 요약이 여기에 표시됩니다 -->
                </div>
            `;
            
            dynamicContentContainer.appendChild(taskContent);
        }

        function updateDynamicTaskButtons() {
            dynamicTasks.forEach(task => {
                const grid = document.getElementById(`${task.id}-grid`);
                if (!grid) return;

                grid.innerHTML = '';
                
                students.forEach(student => {
                    const studentId = getStudentId(student.number, student.name);
                    const status = dynamicTaskStatuses[task.id][studentId] || 'not-submitted';
                    
                    const btn = document.createElement('button');
                    btn.className = `student-btn ${status}`;
                    btn.innerHTML = `
                        <div class="student-name">${student.number}번 ${student.name}</div>
                        <div class="student-status">${getStatusText(status, 'dynamic')}</div>
                    `;
                    btn.onclick = () => toggleDynamicStatus(studentId, task.id);
                    grid.appendChild(btn);
                });

                updateDynamicSummary(task.id);
            });
        }

        function toggleDynamicStatus(studentId, taskId) {
            const currentStatus = dynamicTaskStatuses[taskId][studentId];
            dynamicTaskStatuses[taskId][studentId] = currentStatus === 'not-submitted' ? 'submitted' : 'not-submitted';
            
            updateDynamicTaskButtons();
            saveToStorage();
        }

        function resetAllDynamic(taskId) {
            students.forEach(student => {
                const studentId = getStudentId(student.number, student.name);
                dynamicTaskStatuses[taskId][studentId] = 'not-submitted';
            });
            
            updateDynamicTaskButtons();
            saveToStorage();
        }

        function markAllSubmittedDynamic(taskId) {
            students.forEach(student => {
                const studentId = getStudentId(student.number, student.name);
                dynamicTaskStatuses[taskId][studentId] = 'submitted';
            });
            
            updateDynamicTaskButtons();
            saveToStorage();
        }

        function updateDynamicSummary(taskId) {
            const summaryElement = document.getElementById(`${taskId}-summary`);
            if (!summaryElement) return;

            const statuses = Object.values(dynamicTaskStatuses[taskId] || {});
            const submittedCount = statuses.filter(status => status === 'submitted').length;
            const totalCount = students.length;

            summaryElement.innerHTML = `
                <strong>과제 제출 현황:</strong> 
                제출 ${submittedCount}명 / 미제출 ${totalCount - submittedCount}명 / 전체 ${totalCount}명
                <br>
                <strong>제출률:</strong> ${totalCount > 0 ? Math.round((submittedCount / totalCount) * 100) : 0}%
            `;
        }// 전체 초기화
        function resetAll(type) {
            if (type === 'attendance') {
                students.forEach(student => {
                    const studentId = getStudentId(student.number, student.name);
                    attendanceStatus[studentId] = 'absent';
                });
            } else {
                students.forEach(student => {
                    const studentId = getStudentId(student.number, student.name);
                    assignmentStatus[studentId] = 'not-submitted';
                });
            }
            
            createStudentButtons();
            updateSummary(type);
            saveToStorage(); // 상태 변경시 저장
        }

        // 전체 출석 처리
        function markAllPresent() {
            students.forEach(student => {
                const studentId = getStudentId(student.number, student.name);
                attendanceStatus[studentId] = 'present';
            });
            
            createStudentButtons();
            updateSummary('attendance');
            saveToStorage(); // 상태 변경시 저장
        }

        // 전체 제출 처리
        function markAllSubmitted() {
            students.forEach(student => {
                const studentId = getStudentId(student.number, student.name);
                assignmentStatus[studentId] = 'submitted';
            });
            
            createStudentButtons();
            updateSummary('assignment');
            saveToStorage(); // 상태 변경시 저장
        }

        // 요약 업데이트
        function updateSummary(type) {
            const summaryElement = document.getElementById(`${type}-summary`);
            let presentCount = 0;
            let totalCount = students.length;

            if (type === 'attendance') {
                presentCount = Object.values(attendanceStatus).filter(status => status === 'present').length;
                summaryElement.innerHTML = `
                    <strong>과제 제출 현황:</strong> 
                    제출 ${presentCount}명 / 미제출출 ${totalCount - presentCount}명 / 전체 ${totalCount}명
                    <br>
                    <strong>제출출률:</strong> ${Math.round((presentCount / totalCount) * 100)}%
                `;
            } else {
                presentCount = Object.values(assignmentStatus).filter(status => status === 'submitted').length;
                summaryElement.innerHTML = `
                    <strong>과제 제출 현황:</strong> 
                    제출 ${presentCount}명 / 미제출 ${totalCount - presentCount}명 / 전체 ${totalCount}명
                    <br>
                    <strong>제출률:</strong> ${Math.round((presentCount / totalCount) * 100)}%
                `;
            }
        }

        // 드래그 앤 드롭 관련 변수
        let draggedElement = null;
        let draggedTaskId = null;
        let draggedIndex = null;        // 통합된 드래그 시작 핸들러
        function handleUnifiedDragStart(event) {
            draggedElement = event.target;
            draggedTaskId = event.target.dataset.taskId;
            
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', event.target.outerHTML);
        }        // 통합된 드롭 핸들러
        function handleUnifiedDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const target = event.target.closest('.sidebar-item.draggable');
            if (target && target !== draggedElement) {
                const targetTaskId = target.dataset.taskId;
                
                // 드롭 위치 결정
                const rect = target.getBoundingClientRect();
                const midY = rect.top + rect.height / 2;
                const insertBefore = event.clientY < midY;
                
                // 전체 과제 순서 재배치
                reorderAllTasks(draggedTaskId, targetTaskId, insertBefore);
                
                // UI 업데이트 및 저장
                updateAllTasksOrder();
                saveToStorage();
                
                // 드래그 상태 클리어
                clearDragStyles();
            }
        }

        // 드래그 오버
        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            const target = event.target.closest('.sidebar-item.draggable');
            if (target && target !== draggedElement) {
                const rect = target.getBoundingClientRect();
                const midY = rect.top + rect.height / 2;
                
                // 마우스가 요소의 위쪽 절반에 있으면 위에 삽입, 아래쪽 절반에 있으면 아래에 삽입
                if (event.clientY < midY) {
                    target.classList.remove('drag-over-bottom');
                    target.classList.add('drag-over');
                } else {
                    target.classList.remove('drag-over');
                    target.classList.add('drag-over-bottom');
                }
            }
        }

        // 드래그 엔터
        function handleDragEnter(event) {
            event.preventDefault();
        }

        // 드래그 리브
        function handleDragLeave(event) {
            const target = event.target.closest('.sidebar-item.draggable');
            if (target) {
                target.classList.remove('drag-over', 'drag-over-bottom');
            }
        }        // 드래그 시작 (동적 과제용 - 통합됨)
        function handleDragStart(event) {
            // 이 함수는 이제 handleUnifiedDragStart로 대체됨
            return handleUnifiedDragStart(event);
        }

        // 드롭 (동적 과제용 - 통합됨)
        function handleDrop(event) {
            // 이 함수는 이제 handleUnifiedDrop으로 대체됨
            return handleUnifiedDrop(event);
        }

        // 드래그 종료
        function handleDragEnd(event) {
            clearDragStyles();
        }

        // 드래그 스타일 클리어
        function clearDragStyles() {
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('dragging', 'drag-over', 'drag-over-bottom');
            });
            draggedElement = null;
            draggedTaskId = null;
            draggedIndex = null;
        }

        // 과제 순서 재배치
        function reorderTasks(fromIndex, toIndex, insertBefore) {
            // 드래그된 요소를 배열에서 제거
            const draggedTask = dynamicTasks.splice(fromIndex, 1)[0];
            
            // 새로운 위치 계산
            let newIndex = toIndex;
            
            // 원래 위치가 새 위치보다 앞에 있었다면, 인덱스 조정
            if (fromIndex < toIndex) {
                newIndex -= 1;
            }
              // insertBefore가 false면 요소 뒤에 삽입
            if (!insertBefore) {
                newIndex += 1;
            }
            
            // 새로운 위치에 요소 삽입
            dynamicTasks.splice(newIndex, 0, draggedTask);
        }

        // 과제 순서 로드 함수
        function loadTaskOrder() {
            const storedData = localStorage.getItem(STORAGE_KEY);
            if (storedData) {
                try {
                    const parsedData = JSON.parse(storedData);
                    if (parsedData.allTasksOrder) {
                        allTasksOrder = parsedData.allTasksOrder;
                    }
                } catch (error) {
                    console.error('과제 순서 로드 실패:', error);
                }
            }
        }

        // 과제 순서 저장 함수
        function saveTaskOrder() {
            const dataToSave = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            dataToSave.allTasksOrder = allTasksOrder;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
        }        // 전체 과제 순서 재배치
        function reorderAllTasks(draggedId, targetId, insertBefore) {
            // allTasksOrder에서 드래그된 요소의 현재 인덱스
            const draggedIndex = allTasksOrder.indexOf(draggedId);
            const targetIndex = allTasksOrder.indexOf(targetId);
            
            if (draggedIndex === -1 || targetIndex === -1) return;
            
            // 배열에서 드래그된 요소 제거
            allTasksOrder.splice(draggedIndex, 1);
            
            // 새로운 위치 계산
            let newIndex = targetIndex;
            if (draggedIndex < targetIndex) {
                newIndex -= 1;
            }
            
            if (!insertBefore) {
                newIndex += 1;
            }
            
            // 새로운 위치에 삽입
            allTasksOrder.splice(newIndex, 0, draggedId);
            
            // dynamicTasks 배열도 순서에 맞게 재정렬
            reorderDynamicTasksArray();
        }

        // 동적 과제 배열을 allTasksOrder에 맞게 재정렬
        function reorderDynamicTasksArray() {
            const newDynamicTasks = [];
            
            allTasksOrder.forEach(taskId => {
                if (taskId !== 'attendance' && taskId !== 'assignment') {
                    const task = dynamicTasks.find(t => t.id === taskId);
                    if (task) {
                        newDynamicTasks.push(task);
                    }
                }
            });
            
            dynamicTasks = newDynamicTasks;
        }        // 전체 과제 순서에 따라 UI 업데이트
        function updateAllTasksOrder() {
            const sidebarNav = document.querySelector('.sidebar-nav');
            const managementBtn = sidebarNav.querySelector('[onclick="switchTab(\'management\')"]');
            const divider = sidebarNav.querySelector('.sidebar-divider');
            const dynamicTasksContainer = document.getElementById('dynamic-tasks');
            
            // 기존 과제 버튼들 제거 (명단 관리와 구분선 제외)
            const taskButtons = sidebarNav.querySelectorAll('.sidebar-item.draggable');
            taskButtons.forEach(btn => btn.remove());
            
            // 빈 동적 과제 컨테이너
            dynamicTasksContainer.innerHTML = '';
            
            // allTasksOrder에 따라 다시 생성
            allTasksOrder.forEach(taskId => {
                if (taskId === 'attendance') {
                    const btn = createTaskButton('attendance', '✏️ 꿈문 제출', 'default');
                    sidebarNav.insertBefore(btn, dynamicTasksContainer);
                } else if (taskId === 'assignment') {
                    const btn = createTaskButton('assignment', '📋 알림장 검사', 'default');
                    sidebarNav.insertBefore(btn, dynamicTasksContainer);
                } else {
                    // 동적 과제
                    const task = dynamicTasks.find(t => t.id === taskId);
                    if (task) {
                        const btn = createTaskButton(task.id, `${task.icon} ${task.name}`, 'dynamic');
                        dynamicTasksContainer.appendChild(btn);
                    }
                }
            });
        }        // 과제 버튼 생성 헬퍼 함수
        function createTaskButton(taskId, text, type) {
            const button = document.createElement('button');
            button.className = 'sidebar-item draggable';
            button.setAttribute('onclick', `switchTab('${taskId}')`);
            button.setAttribute('draggable', 'true');
            button.setAttribute('data-task-id', taskId);
            button.setAttribute('data-task-type', type);
            
            // 모든 과제가 동일한 통합된 핸들러 사용
            button.setAttribute('ondragstart', 'handleUnifiedDragStart(event)');
            button.setAttribute('ondragover', 'handleDragOver(event)');
            button.setAttribute('ondrop', 'handleUnifiedDrop(event)');
            button.setAttribute('ondragenter', 'handleDragEnter(event)');
            button.setAttribute('ondragleave', 'handleDragLeave(event)');
            button.setAttribute('ondragend', 'handleDragEnd(event)');
            
            const deleteBtn = document.createElement('span');
            deleteBtn.className = 'task-delete-btn';
            if (type === 'default') {
                deleteBtn.setAttribute('onclick', `event.stopPropagation(); deleteDefaultTask('${taskId}')`);
            } else {
                deleteBtn.setAttribute('onclick', `event.stopPropagation(); deleteTask('${taskId}')`);
            }
            deleteBtn.textContent = '🗑️';
            
            button.innerHTML = text;
            button.appendChild(deleteBtn);
            
            return button;        }

        // 앱 시작
        window.addEventListener('DOMContentLoaded', initializeApp);

        // ...existing code...
    </script>
</body>
</html>